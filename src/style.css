/*
  flymd 样式（中文注释）
  目标：极简、即开即见，默认全屏编辑；预览为覆盖层，Ctrl+E 切换
*/


:root {
  color-scheme: light dark;
  --bg: #ffffff;
  --fg: #1f2328;
  --muted: #7a7a7a;
  --border: #e5e7eb;
  /* 更清晰的边框与代码背景（所见模式用） */
  --border-strong: #cbd5e1; /* slate-300 */
  --panel-bg: #f3f4f6;
  /* 所见模式变量 */
  --wysiwyg-bg: #e9edf5;           /* 更深一点的蓝灰 */
  --wysiwyg-status-h: 24px;        /* 状态条高度 */
  --wysiwyg-status-bg: #d9e2f2;    /* 状态条背景 */
  --code-bg: #f6f8fa;              /* 代码块背景（亮） */
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg: #0b0c0e;
    --fg: #e5e7eb;
    --muted: #9ca3af;
    --border: #1f2937;
    --border-strong: #374151;      /* slate-700 */
    --panel-bg: #0e1217;
    /* 深色所见模式变量 */
    --wysiwyg-bg: #0b1016;         /* 更深的蓝黑 */
    --wysiwyg-status-bg: #0f1a24;  /* 状态条背景 */
    --code-bg: #111827;            /* 代码块背景（暗） */
  }
}
html, body, #app { height: 100%; }
html, body { margin: 0; padding: 0; background: var(--bg); color: var(--fg); }

.titlebar {
  height: 32px;
  display: flex;
  align-items: stretch;
  border-bottom: 1px solid var(--border);
  -webkit-app-region: drag; /* Windows 可拖动区域 */
  background: var(--bg);
}

/* 菜单栏样式 - 类似 Windows 记事本 */
.menubar {
  -webkit-app-region: no-drag;
  display: flex;
  align-items: stretch;
}

.menu-item {
  -webkit-app-region: no-drag;
  display: flex;
  align-items: center;
  padding: 0 12px;
  font-size: 12px;
  color: var(--fg);
  cursor: pointer;
  user-select: none;
  border: none;
  background: transparent;
  transition: background-color 0.1s;
  position: relative; /* 便于放置红点提示 */
}

.menu-item:hover {
  background: rgba(127,127,127,0.12);
}

.menu-item:active {
  background: rgba(127,127,127,0.18);
}

/* 更新红点提示：为有更新的菜单项显示小圆点 */
.menu-item.has-update::after {
  content: '';
  position: absolute;
  top: 6px;
  right: 6px;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #e11d48; /* 玫瑰红 */
  box-shadow: 0 0 0 2px var(--bg);
}

.titlebar .filename {
  flex: 1;
  display: flex;
  align-items: center;
  padding: 0 12px;
  font-size: 12px;
  color: var(--muted);
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

.container { height: calc(100% - 32px); position: relative; }
/* 所见模式：整体容器背景替换为专用色 */
.container.wysiwyg { /* legacy overlay 标记，保留但不隐藏容器，避免误伤 */ }
.container.wysiwyg-v2 { background: var(--wysiwyg-bg) !important; }

.editor {
  width: 100%; height: 100%;
  border: none; outline: none; resize: none;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 14px; line-height: 1.6; color: var(--fg);
  background: var(--bg);
  padding: 14px 16px 40px 16px;
  box-sizing: border-box;
}

.preview {
  position: absolute; inset: 0;
  /* 仅显示竖向滚动条，隐藏横向滚动条，避免页面抖动且更清爽 */
  overflow-y: auto; overflow-x: hidden;
  padding: 16px 20px 40px 20px;
  background: var(--bg); color: var(--fg);
}
.preview.hidden { display: none; }

/* 所见 V2：真实所见视图容器 */
#md-wysiwyg-root, #md-wysiwyg-root * { box-sizing: border-box; }
#md-wysiwyg-root { position: absolute; inset: 0; display: none; overflow-y: auto; overflow-x: hidden; z-index: 2; }
.container.wysiwyg-v2 #md-wysiwyg-root { display: block; }
.container.wysiwyg-v2-loading #md-wysiwyg-root { display: none; }
.container.wysiwyg-v2 .editor { display: none; }
.container.wysiwyg-v2-loading .editor { display: block; }
.container.wysiwyg-v2 .preview { display: none !important; }
/* 所见模式覆盖渲染容器：在 ProseMirror 之上渲染 Mermaid/KaTeX 预览 */
#md-wysiwyg-root .overlay-host { position: absolute; inset: 0; pointer-events: none; z-index: 5; }
#md-wysiwyg-root .overlay-host .ov-mermaid,
#md-wysiwyg-root .overlay-host .ov-katex { pointer-events: none; }
#md-wysiwyg-root .overlay-host .ov-mermaid > div,
#md-wysiwyg-root .overlay-host .ov-katex > div { pointer-events: auto; }
/* 保证所见 V2 的滚动容器占满并可滚动 */
#md-wysiwyg-root .scrollView { height: 100%; overflow-y: auto; }
/* 兜底：Milkdown 根容器（通常为 .milkdown）与其第一级子元素占满高度 */
#md-wysiwyg-root > .milkdown { display: block; min-height: 100%; height: 100%; }
#md-wysiwyg-root > div { display: block; min-height: 100%; }

/* V2 状态提示（右下角） */
/* 右下角提示已取消 */

/* 如有富文本工具条，默认隐藏，纯所见编辑 */
#md-wysiwyg-root [role="toolbar"] { display: none !important; }
/* 隐藏 Milkdown block/slash 插件的 UI 组件（更精确的选择器，不影响内容块） */
#md-wysiwyg-root .milkdown-menu { display: none !important; }
#md-wysiwyg-root [data-block-handle] { display: none !important; }
#md-wysiwyg-root [data-slash-menu] { display: none !important; }
#md-wysiwyg-root .slash-dropdown { display: none !important; }
#md-wysiwyg-root .block-menu { display: none !important; }
/* 隐藏全局的浮动 UI 面板（portal 到 body 的元素） */
body > [data-tippy-root] { display: none !important; }
body > [data-block-handle] { display: none !important; }
body > [data-slash-menu] { display: none !important; }
body > .milkdown-menu { display: none !important; }
body > .slash-dropdown { display: none !important; }
body > .block-menu { display: none !important; }

/* ProseMirror 基础样式，确保 V2 视图可编辑、可滚动、行距正常 */
.container.wysiwyg-v2 .ProseMirror {
  min-height: 100%;
  padding: 14px 16px 40px 16px;
  outline: none;
  white-space: pre-wrap;
  word-break: break-word;
  color: var(--fg);
  /* 居中与阅读宽度（对齐预览的 preview-body） */
  max-width: 860px;
  margin: 0 auto;
  background: transparent;
  box-sizing: border-box;
}
.container.wysiwyg-v2 .ProseMirror img,
.container.wysiwyg-v2 .ProseMirror video { max-width: 100%; height: auto; }
.container.wysiwyg-v2 .ProseMirror table { width: auto; max-width: 100%; border-collapse: collapse; }
.container.wysiwyg-v2 .ProseMirror th,
.container.wysiwyg-v2 .ProseMirror td { border: 1px solid var(--border-strong); padding: 6px 8px; }
.container.wysiwyg-v2 .ProseMirror:focus { outline: none; }
.container.wysiwyg-v2 .ProseMirror p { margin: 0.6em 0; }
.container.wysiwyg-v2 .ProseMirror pre {
  background: var(--code-bg);
  padding: 10px;
  border-radius: 8px;
  overflow: auto;
  border: none; /* 去掉所见模式代码块边框 */
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}
.container.wysiwyg-v2 .ProseMirror code {
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  background: var(--code-bg);
  padding: 2px 4px;
  border-radius: 4px;
  border: none; /* 去掉所见模式行内代码边框 */
}
.container.wysiwyg-v2 .ProseMirror blockquote { border-left: 3px solid var(--border-strong); padding-left: 10px; color: var(--muted); }

/* 所见模式的临时预览 UI 提升可见性 */
#wysi-preview-popover { border-color: var(--border-strong) !important; }
#wysi-float-preview { border-color: var(--border-strong) !important; }
#md-wysiwyg-root .mmd-preview { border-color: var(--border-strong) !important; }

/* 所见模式覆盖：即使预览带有 hidden 类，也强制显示 */
.container.wysiwyg .preview.hidden { display: block; }

/* 所见模式：预览在下，编辑器在上（透明文字，仅显示光标） */
.container.wysiwyg .preview {
  z-index: 1;
  opacity: 1;
  pointer-events: none; /* 不拦截点击，V1 仅显示 */
  /* 与编辑器对齐（避免文字看起来在光标“下面”） */
  padding: 14px 16px 40px 16px; /* 与 .editor 一致 */
  /* 使用与编辑器完全一致的等宽字体，保证 ch 宽度一致 */
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 14px; /* 与 .editor 一致 */
  /* 微调变量（如需细调可在运行时动态注入样式覆盖） */
  --w-nudge-x: 0.5ch;   /* 标题横向整体微调，默认约半个西文字符 */
  --w-head-top: -0.10em;/* 标题纵向上移，缓解“在下方”感受 */
}
.container.wysiwyg .editor {
  position: relative;
  z-index: 2;
  background: transparent;
  color: transparent;          /* 隐藏文本 */
  caret-color: var(--fg);      /* 仍显示光标 */
  /* 使用与常规编辑相同的等宽字体，确保字符宽度匹配 */
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  line-height: 1.6;            /* 与预览一致 */
}

/* 可选：所见模式隐藏光标，结合“高亮当前行”使用 */
/* 所见模式：显式要求隐藏系统插入符（取消光标） */
.container.wysiwyg.no-caret .editor { caret-color: transparent !important; }
/* 同时禁用自定义覆盖光标 */
.container.wysiwyg.no-caret .wysiwyg-caret { display: none !important; }

/* 所见模式：高亮当前编辑的逻辑行（整页宽，指示当前位置） */
.container.wysiwyg .wysiwyg-line {
  position: absolute; left: 0; right: 0; height: 1.6em;
  background: rgba(127,127,127,0.12);
  z-index: 2; pointer-events: none;
  display: none;
}
.container.wysiwyg .wysiwyg-line.show { display: block; }

/* 所见模式：点状光标（替代竖线光标） */
.container.wysiwyg .wysiwyg-caret {
  position: absolute; z-index: 3; pointer-events: none;
  /* 采用“终端式”下划线光标：宽度等于 1 个字符宽，厚度很薄 */
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  width: 1ch; height: 2px; border-radius: 1px;
  background: var(--fg);
  /* 以 left 顶边为锚点，不再居中偏移 */
  transform: none;
  display: none;
}
.container.wysiwyg .wysiwyg-caret.show { display: block; }
/* 光标闪烁动画（所见模式） */
@keyframes caret-blink {
  0%, 49% { opacity: 1; }
  50%, 100% { opacity: 0; }
}
.container.wysiwyg .wysiwyg-caret.show {
  animation: caret-blink 1s steps(1, end) infinite;
}
@media (prefers-reduced-motion: reduce) {
  .container.wysiwyg .wysiwyg-caret.show { animation: none; }
}
/* 注入到预览中的点状“光标”样式 */
.container.wysiwyg .preview .caret-dot {
  color: var(--fg);
  animation: caret-blink 1s steps(1, end) infinite;
}

/* 取消预览正文的居中与段落外边距，使与 textarea 行基线更贴合 */
.container.wysiwyg .preview-body { max-width: none; margin: 0; }
.container.wysiwyg .preview p { margin: 0; }
/* 使段落/标题换行行为更贴近 textarea */
.container.wysiwyg .preview p,
.container.wysiwyg .preview h1,
.container.wysiwyg .preview h2,
.container.wysiwyg .preview h3,
.container.wysiwyg .preview h4,
.container.wysiwyg .preview h5,
.container.wysiwyg .preview h6 { white-space: pre-wrap; word-break: break-word; }
/* 所见模式：代码块与编辑器严格对齐 */
.container.wysiwyg .preview pre {
  margin-top: 0; margin-bottom: 0;
  padding-top: 0; padding-bottom: 0;
  line-height: 1.6; /* 与 .editor 相同 */
}
.container.wysiwyg .preview pre code {
  font-size: 14px; /* 与 .editor 相同 */
  line-height: 1.6;
}

/* 标题在所见模式下的对齐优化：
   - 移除上下外边距，避免块级顶部下坠
   - 统一行高到与编辑器一致
   - 使用 text-indent + padding-left 抵消 Markdown 源中 "# " 前缀在横向上的差异
*/
.container.wysiwyg .preview h1,
.container.wysiwyg .preview h2,
.container.wysiwyg .preview h3,
.container.wysiwyg .preview h4,
.container.wysiwyg .preview h5,
.container.wysiwyg .preview h6 {
  margin: 0;
  line-height: 1.6;        /* 使用与编辑器一致的行高（单位less）*/
  position: relative;
  top: var(--w-head-top);
  font-size: 1em;          /* 基准字体大小与编辑器一致 */
  font-weight: 700;        /* 保留“标题感” */
  display: block;          /* 块级，避免多个标题同排显示 */
  transform-origin: left top;
}

/* 标题放大采用 transform，不改变行框高度，从而与输入光标保持一致。
   同时将左侧缩进按比例缩放前反向抵消，保证“# ”被移除后起点对齐。*/
.container.wysiwyg .preview h1 {
  --hscale: 1.60;
  transform: scale(var(--hscale));
  text-indent: calc((-2ch - var(--w-nudge-x)) / var(--hscale));
  padding-left: calc((2ch + var(--w-nudge-x)) / var(--hscale));
  padding-bottom: 0.60em; /* 为放大后的视觉高度预留空间，避免压住下一行 */
}
.container.wysiwyg .preview h2 {
  --hscale: 1.40;
  transform: scale(var(--hscale));
  text-indent: calc((-3ch - var(--w-nudge-x)) / var(--hscale));
  padding-left: calc((3ch + var(--w-nudge-x)) / var(--hscale));
  padding-bottom: 0.45em;
}
.container.wysiwyg .preview h3 {
  --hscale: 1.20;
  transform: scale(var(--hscale));
  text-indent: calc((-4ch - var(--w-nudge-x)) / var(--hscale));
  padding-left: calc((4ch + var(--w-nudge-x)) / var(--hscale));
  padding-bottom: 0.30em;
}
.container.wysiwyg .preview h4 {
  --hscale: 1.10;
  transform: scale(var(--hscale));
  text-indent: calc((-5ch - var(--w-nudge-x)) / var(--hscale));
  padding-left: calc((5ch + var(--w-nudge-x)) / var(--hscale));
  padding-bottom: 0.20em;
}
.container.wysiwyg .preview h5 {
  --hscale: 1.00;
  transform: scale(var(--hscale));
  text-indent: calc((-6ch - var(--w-nudge-x)) / var(--hscale));
  padding-left: calc((6ch + var(--w-nudge-x)) / var(--hscale));
  padding-bottom: 0.10em;
}
.container.wysiwyg .preview h6 {
  --hscale: 1.00;
  transform: scale(var(--hscale));
  text-indent: calc((-7ch - var(--w-nudge-x)) / var(--hscale));
  padding-left: calc((7ch + var(--w-nudge-x)) / var(--hscale));
  padding-bottom: 0.10em;
}

/* 预览正文容器：定宽居中，类似 Typora/Word 的阅读宽度 */
.preview-body {
  max-width: 860px;   /* 可按需微调，例如 720/800/900 */
  margin: 0 auto;
}

/* 文档库侧栏（阶段A：最小侵入） */
.library { position: absolute; inset: 0 auto 0 0; width: 280px; border-right: 1px solid var(--border); background: var(--panel-bg); color: var(--fg); overflow-y: auto; overflow-x: hidden; z-index: 15; }
.library.hidden { display: none; }
.library .lib-header { position: sticky; top: 0; background: var(--panel-bg); border-bottom: 1px solid var(--border); padding: 8px 10px; font-size: 12px; display: flex; align-items: center; gap: 8px; }
.library .lib-path { flex: 1; color: var(--muted); overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
.library .lib-btn { -webkit-app-region: no-drag; cursor: pointer; border: 1px solid var(--border); background: rgba(127,127,127,0.08); color: var(--fg); border-radius: 6px; padding: 4px 8px; font-size: 12px; }
.library .lib-btn:hover { background: rgba(127,127,127,0.14); }
.library .lib-tree { padding: 8px 6px 14px 6px; font-size: 13px; }
.library .lib-node { display: flex; align-items: center; gap: 6px; padding: 4px 6px; border-radius: 6px; cursor: default; user-select: none; }
.library .lib-node:hover { background: rgba(127,127,127,0.08); }
.library .lib-dir { cursor: pointer; }
.library .lib-file { cursor: pointer; }
.library .lib-toggle { width: 12px; text-align: center; color: var(--muted); }
.library .lib-children { margin-left: 14px; }

/* 侧栏行内简易图标，避免 Emoji 字体兼容性问题 */
.library .lib-ico { display: inline-block; vertical-align: middle; width: 16px; height: 16px; fill: var(--muted); stroke: var(--muted); }
.library .lib-node:hover .lib-ico { fill: var(--fg); stroke: var(--fg); }
/* 保留文件图标的简易形状，后续可同样替换为 SVG */
.library .lib-ico-file { position: relative; width: 10px; height: 12px; border: 1px solid currentColor; border-radius: 2px; box-sizing: border-box; }
.library .lib-ico-file::after { content: ''; position: absolute; right: 0; top: 0; width: 0; height: 0; border-left: 4px solid transparent; border-bottom: 4px solid currentColor; }

/* 展示库时，为编辑/预览留出空间（不改动原有 DOM） */
.container.with-library .editor,
.container.with-library .preview { padding-left: 300px; }
/* 所见 V2 打开文档库侧栏时，避免编辑区被左侧面板覆盖 */
.container.with-library #md-wysiwyg-root { left: 300px; width: calc(100% - 300px); }
/* 所见 V2 在“固定库”模式下仍保持全宽，让库覆盖在上方，不挤压所见编辑区 */
.container.wysiwyg-v2.with-library #md-wysiwyg-root { left: 0; width: 100%; }

.statusbar {
  position: absolute; right: 10px; bottom: 8px; font-size: 12px; color: var(--muted);
}

/* Markdown 基础排版（预览） */
.preview h1,.preview h2,.preview h3,.preview h4,.preview h5,.preview h6 { margin: 1.2em 0 0.6em; }
.preview p { margin: 0.6em 0; }
.preview pre { background: var(--code-bg); border: 1px solid var(--code-border); padding: 16px; border-radius: 8px; overflow: auto; }
.preview code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background: var(--code-bg); border: 1px solid var(--code-border); padding: 2px 6px; border-radius: 4px; }
.preview blockquote { border-left: 3px solid var(--border); margin: 0.8em 0; padding: 4px 10px; color: var(--muted); }
.preview table { border-collapse: collapse; }
.preview table th, .preview table td { border: 1px solid var(--border); padding: 6px 8px; }
.preview img { display: block; margin: 8px auto; }
.preview img:not([width]):not([height]) { max-width: 70%; height: auto; }

/* 最近文件 面板 */
.recent-panel {
  position: absolute;
  top: 38px;
  left: 10px;
  min-width: 280px;
  max-width: 520px;
  max-height: 260px;
  overflow: auto;
  background: var(--bg);
  color: var(--fg);
  border: 1px solid var(--border);
  border-radius: 8px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.12);
  z-index: 20;
}
.recent-panel.hidden { display: none; }
.recent-panel .empty { padding: 10px 12px; color: var(--muted); font-size: 12px; }
.recent-panel .item { padding: 8px 12px; cursor: pointer; font-size: 13px; }
.recent-panel .item:hover { background: rgba(127,127,127,0.08); }
.recent-panel .path { font-size: 11px; color: var(--muted); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* 关于 弹窗 */
.about-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.35); display: flex; align-items: center; justify-content: center; z-index: 50; }
.about-overlay.hidden { display: none; }
.about-dialog { width: 460px; max-width: calc(100% - 40px); background: var(--bg); color: var(--fg); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 12px 36px rgba(0,0,0,0.2); }
.about-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid var(--border); font-weight: 600; font-size: 14px; }
.about-close { cursor: pointer; border: none; background: transparent; color: var(--muted); font-size: 16px; line-height: 1; padding: 4px; border-radius: 6px; }
.about-close:hover { background: rgba(127,127,127,0.12); }
.about-body { padding: 14px 16px 16px 16px; font-size: 13px; line-height: 1.6; }
.about-body p { margin: 0.4em 0; }
.about-subtitle { margin-top: 10px; font-weight: 600; font-size: 13px; }
.about-shortcuts { margin-top: 8px; display: grid; grid-template-columns: 1fr auto; column-gap: 16px; row-gap: 6px; align-items: center; }
.about-shortcuts .sc-act { color: var(--fg); }
.about-shortcuts .sc-keys { color: var(--muted); }
.about-body kbd { display: inline-block; min-width: 20px; padding: 2px 6px; border: 1px solid var(--border); border-bottom-width: 2px; border-radius: 6px; background: rgba(127,127,127,0.08); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; color: var(--fg); }
.about-footer { display: flex; justify-content: flex-end; align-items: center; gap: 12px; padding: 8px 12px; border-top: 1px solid var(--border); }
.about-footer #about-version { font-size: 12px; color: var(--muted); }
.about-footer a { color: #2563eb; text-decoration: none; font-size: 12px; display: inline-flex; align-items: center; gap: 6px; }
.about-footer a:hover { text-decoration: underline; }
.about-footer .sep { color: var(--muted); font-size: 12px; }
.about-footer .favicon { width: 16px; height: 16px; border-radius: 3px; }

/* 隐藏正文中的关于链接区域（已移至底部右侧） */
.about-body .about-links { display: none; }
.about-links { margin-top: 10px; }
.about-links a { color: #2563eb; text-decoration: none; }
.about-links a:hover { text-decoration: underline; }

/* 插入链接 对话框 */
.link-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.35); display: flex; align-items: center; justify-content: center; z-index: 60; }
.link-overlay.hidden { display: none; }
.link-dialog { width: 420px; max-width: calc(100% - 40px); background: var(--bg); color: var(--fg); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 12px 36px rgba(0,0,0,0.2); }
.link-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid var(--border); font-weight: 600; font-size: 14px; }
.link-body { padding: 14px 16px 16px 16px; }
.link-field { display: grid; grid-template-columns: 64px 1fr; align-items: center; gap: 10px; margin: 10px 0; font-size: 13px; }
.link-field span { color: var(--muted); }
.link-field input { width: 100%; padding: 8px 10px; border: 1px solid var(--border); background: var(--bg); color: var(--fg); border-radius: 8px; outline: none; font-size: 13px; min-width: 0; box-sizing: border-box; }
.link-field input:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,0.15); }
.link-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 12px; }
.link-actions button { -webkit-app-region: no-drag; cursor: pointer; border: 1px solid var(--border); background: rgba(127,127,127,0.08); color: var(--fg); border-radius: 8px; padding: 6px 12px; font-size: 13px; }
.link-actions button:hover { background: rgba(127,127,127,0.14); }

/* 图床设置 对话框 */
.upl-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.35); display: flex; align-items: center; justify-content: center; z-index: 65; }
.upl-overlay.hidden { display: none; }
.upl-dialog { width: 520px; max-width: calc(100% - 40px); background: var(--bg); color: var(--fg); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 12px 36px rgba(0,0,0,0.2); }
.upl-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid var(--border); font-weight: 600; font-size: 14px; }
.upl-body { padding: 14px 16px 16px 16px; max-height: 65vh; overflow: auto; }
.upl-grid { display: grid; grid-template-columns: 120px 1fr; align-items: center; gap: 10px; }
.upl-field { display: contents; }
.upl-grid label { color: var(--muted); font-size: 12px; }
.upl-grid input[type="text"], .upl-grid input[type="password"], .upl-grid input[type="url"] { width: 100%; padding: 8px 10px; border: 1px solid var(--border); background: var(--bg); color: var(--fg); border-radius: 8px; outline: none; font-size: 13px; min-width: 0; box-sizing: border-box; }
.upl-grid input:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,0.15); }
.upl-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 12px; }
.upl-actions button { -webkit-app-region: no-drag; cursor: pointer; border: 1px solid var(--border); background: rgba(127,127,127,0.08); color: var(--fg); border-radius: 8px; padding: 6px 12px; font-size: 13px; }
.upl-actions button:hover { background: rgba(127,127,127,0.14); }

/* === UI 美化补充（库侧栏与图床设置）=== */
/* 库侧栏：行高、箭头、图标配色与悬停态 */
.library .lib-node { min-height: 26px; gap: 8px; padding: 4px 8px; }
.library .lib-node .lib-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.library .lib-node .lib-tg { width: 14px; height: 14px; color: var(--muted); transition: transform .12s ease; }
.library .lib-node.expanded .lib-tg { transform: rotate(90deg); color: var(--fg); }
.library .lib-ico { width: 16px; height: 16px; color: var(--muted); fill: currentColor; }
.library .lib-node:hover .lib-ico { color: var(--fg); }
.library .lib-ico-folder { color: #f59e0b; } /* 简约点缀色：琥珀 */
@media (prefers-color-scheme: dark) {
  .library .lib-ico-folder { color: #fbbf24; }
}
/* 替换文件图标为简约 SVG，保留旧类避免破坏布局 */
.library .lib-ico-file { width: 14px; height: 16px; display: inline-block; }

/* 树形缩进更柔和 */
.library .lib-children { margin-left: 16px; border-left: 1px dashed rgba(127,127,127,0.2); padding-left: 6px; }

/* 图床设置弹窗：分组与描述、开关样式、提示文案 */
.upl-desc { margin: 8px 16px 0 16px; font-size: 12px; color: var(--muted); }
.upl-section-title { grid-column: 1 / -1; margin: 12px 0 4px 0; font-weight: 600; font-size: 12px; color: var(--fg); opacity: .9; }
.upl-hint { grid-column: 2 / -1; margin: 4px 0 2px 0; font-size: 12px; color: var(--muted); }

/* 简约开关（复用 checkbox）*/
.switch { position: relative; width: 38px; height: 22px; display: inline-block; }
.switch input { display: none; }
.switch .trk { position: absolute; inset: 0; background: rgba(127,127,127,0.25); border-radius: 999px; transition: background-color .12s ease; }
.switch .kn { position: absolute; top: 2px; left: 2px; width: 18px; height: 18px; border-radius: 50%; background: var(--bg); box-shadow: 0 1px 2px rgba(0,0,0,.15); transition: transform .12s ease; }
.switch input:checked + .trk { background: #2563eb; }
.switch input:checked + .trk + .kn { transform: translateX(16px); }

/* 操作区按钮语义色 */
.upl-actions .btn-secondary { border-color: var(--border); background: rgba(127,127,127,0.08); }
.upl-actions .btn-primary { border-color: #2563eb; background: #2563eb; color: #fff; }
.upl-actions .btn-primary:hover { filter: brightness(1.05); }

/* 测试结果 */
#upl-test-result { margin-left: auto; font-size: 12px; color: var(--muted); }
#upl-test-result.ok { color: #16a34a; }
#upl-test-result.err { color: #dc2626; }

/* === 全局滚动控制：去掉窗口级滚动，仅内部滚动 === */
html, body { overflow: hidden; }
/* 扩展管理弹窗 */
.ext-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.35); z-index: 80000; }
.ext-overlay.show { display: flex; }
.ext-dialog { width: 720px; max-width: calc(100% - 40px); background: var(--bg); color: var(--fg); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 12px 36px rgba(0,0,0,.2); }
.ext-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid var(--border); font-weight: 600; font-size: 14px; }
.ext-close { border: none; background: transparent; color: var(--fg); cursor: pointer; font-size: 18px; line-height: 1; }
.ext-body { padding: 12px 14px; max-height: 65vh; overflow: auto; }
.ext-section { margin: 8px 0 14px 0; }
.ext-subtitle { font-weight: 600; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
.ext-install { display: flex; gap: 8px; }
.ext-install input[type="text"] { flex: 1; padding: 8px 10px; border: 1px solid var(--border); background: var(--bg); color: var(--fg); border-radius: 8px; outline: none; font-size: 13px; min-width: 0; box-sizing: border-box; }
.ext-install button { padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: rgba(127,127,127,0.08); color: var(--fg); cursor: pointer; }
.ext-install button.primary { border-color: #2563eb; background: #2563eb; color: #fff; }
.ext-list { display: grid; grid-template-columns: 1fr auto; gap: 8px 10px; }
.ext-item { display: contents; }
.ext-item .ext-meta { display: flex; flex-direction: column; gap: 2px; }
.ext-item .ext-name { font-size: 13px; font-weight: 600; }
.ext-item .ext-desc { font-size: 12px; color: var(--muted); }
.ext-item .ext-actions { display: flex; align-items: center; gap: 6px; }
.ext-actions .btn { padding: 6px 10px; border: 1px solid var(--border); border-radius: 8px; background: rgba(127,127,127,0.08); color: var(--fg); cursor: pointer; font-size: 12px; }
.ext-actions .btn.primary { border-color: #2563eb; background: #2563eb; color: #fff; }
.ext-actions .btn.warn { border-color: #ef4444; color: #ef4444; background: rgba(239,68,68,0.08); }
.ext-empty { font-size: 12px; color: var(--muted); }
/* 隐藏插件自建的头部条，避免重复顶栏按钮 */
.tp-fly-headbar { display: none !important; }

/* === Markdown 代码渲染主题（简约）=== */
:root {
  --code-bg: #f6f8fa;
  --code-border: #e5e7eb;
  --code-fg: #1f2328;
  --code-muted: #667085;
  --c-key: #7c3aed;   /* 关键字 */
  --c-str: #2563eb;   /* 字符串 */
  --c-num: #059669;   /* 数字 */
  --c-fn:  #db2777;   /* 函数/标题 */
  --c-com: #9ca3af;  /* 注释 */
}
@media (prefers-color-scheme: dark) {
  :root {
    --code-bg: #0f1114;
    --code-border: #1f2937;
    --code-fg: #e5e7eb;
    --code-muted: #9ca3af;
    --c-key: #a78bfa;
    --c-str: #60a5fa;
    --c-num: #34d399;
    --c-fn:  #f472b6;
    --c-com: #6b7280;
  }
}

/* 块级代码 */
.preview pre { background: var(--code-bg); border: 1px solid var(--code-border); border-radius: 8px; padding: 16px; overflow: auto; -webkit-overflow-scrolling: touch; margin: 12px 0; }
.preview pre code { display: block; background: transparent; color: var(--code-fg); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 13px; line-height: 1.6; }
/* 行内代码 */
.preview :not(pre) > code { background: var(--code-bg); color: var(--code-fg); border: 1px solid var(--code-border); border-radius: 6px; padding: 0 6px; font-size: 0.9em; }

/* hljs token 颜色（不依赖外部主题）*/
.preview code.hljs .hljs-keyword, .preview code.hljs .hljs-selector-tag { color: var(--c-key); }
.preview code.hljs .hljs-title, .preview code.hljs .hljs-section, .preview code.hljs .hljs-function { color: var(--c-fn); }
.preview code.hljs .hljs-string, .preview code.hljs .hljs-attr, .preview code.hljs .hljs-template-variable { color: var(--c-str); }
.preview code.hljs .hljs-number, .preview code.hljs .hljs-literal, .preview code.hljs .hljs-bullet { color: var(--c-num); }
.preview code.hljs .hljs-comment, .preview code.hljs .hljs-quote { color: var(--c-com); font-style: italic; }

/* 代码滚动条可以保留以保证可用性；如需隐藏，可启用下两行 */
/* .preview pre::-webkit-scrollbar { height: 8px; } */
/* .preview pre::-webkit-scrollbar-thumb { background: rgba(127,127,127,0.35); border-radius: 999px; } */

/* === 代码块装饰（语言角标、行号、复制）=== */
.codebox { position: relative; margin: 12px 0; }
.codebox .code-lang { position: absolute; top: 10px; left: 12px; padding: 3px 8px; border: 1px solid var(--code-border); border-radius: 6px; background: var(--bg); color: var(--muted); font-size: 11px; line-height: 1; font-weight: 500; }
.codebox .code-copy { position: absolute; top: 10px; right: 12px; padding: 4px 10px; border: 1px solid var(--code-border); border-radius: 6px; background: rgba(127,127,127,0.08); color: var(--fg); font-size: 11px; cursor: pointer; font-weight: 500; transition: all 0.15s ease; }
.codebox .code-copy:hover { background: rgba(127,127,127,0.16); border-color: var(--fg); }
.codebox pre { margin: 0; position: relative; /* 让行号层可绝对定位 */ }
/* 行号列：绝对定位在 pre 内部左侧，随内容滚动 */
.codebox .code-lnums {
  position: absolute;
  top: 0; bottom: 0; left: 0;
  width: 3.2em;               /* 预留固定列宽 */
  padding-left: 0.4em;         /* 数字向内缩进，贴齐左侧 */
  padding-top: 16px;           /* 与 pre 的 padding-top 保持一致，保证首行对齐 */
  box-sizing: border-box;
  color: var(--code-muted);
  font-size: 13px;             /* 与代码字体一致，避免行高基准不同 */
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; /* 行号使用相同字体，避免度量差 */
  font-variant-numeric: tabular-nums; /* 等宽数字，纵向对齐更整齐 */
  text-align: left;
  pointer-events: none;        /* 不挡操作 */
  z-index: 1;                  /* 低于角标/复制按钮 */
}
.codebox .code-lnums .ln { display: block; line-height: inherit; }
/* 为行号列让出内边距，避免覆盖代码文本 */
.codebox pre { padding-left: calc(16px + 3.2em + 0.4em); }
/* 提升角标/复制按钮层级，避免被行号列覆盖 */
.codebox .code-lang, .codebox .code-copy { z-index: 2; }

/* 阅读模式：移除代码块边框，仅保留背景，不要出现内部横向分隔线 */
.container:not(.wysiwyg) .preview pre { border: none; }

/* 移除阅读模式内所有“横线”式分割视觉（保留背景与内边距） */
.container:not(.wysiwyg) .preview pre * { border: 0 !important; box-shadow: none !important; }

/* === 侧栏文档图标色（按扩展名）=== */
.library .lib-node.file-ext-md .lib-ico-file,
.library .lib-node.file-ext-markdown .lib-ico-file { color: #22c55e; }
.library .lib-node.file-ext-txt .lib-ico-file { color: #64748b; }
.library .lib-node.file-ext-json .lib-ico-file { color: #f59e0b; }
.library .lib-node.file-ext-yml .lib-ico-file,
.library .lib-node.file-ext-yaml .lib-ico-file { color: #38bdf8; }
.library .lib-node.file-ext-js .lib-ico-file { color: #eab308; }
.library .lib-node.file-ext-ts .lib-ico-file { color: #3b82f6; }
.library .lib-node.file-ext-svg .lib-ico-file { color: #8b5cf6; }
.library .lib-node.file-ext-png .lib-ico-file,
.library .lib-node.file-ext-jpg .lib-ico-file,
.library .lib-node.file-ext-jpeg .lib-ico-file,
.library .lib-node.file-ext-gif .lib-ico-file { color: #ec4899; }


/* 程序图标作为文件夹图标 */
.library .lib-ico-app { width: 16px; height: 16px; border-radius: 3px; object-fit: cover; }


/* 库侧栏选中态 */
.library .lib-node.selected { background: rgba(127,127,127,0.16); }


/* FileTree Modals */
#ft-modal { font-size: 13px; }
#ft-modal .ft-box button { cursor: pointer; }

/* 所见模式：覆盖预览背景为专用色 */
.container.wysiwyg .preview { background: var(--wysiwyg-bg); }

/* 所见模式下渲染中：隐藏预览层，避免原始 mermaid 代码短暂闪现 */
.container.wysiwyg .preview.rendering { visibility: hidden; }



/* 所见模式状态条 */
.container.wysiwyg .wysiwyg-status {
  position: absolute; bottom: 12px; right: 12px;
  max-width: 60%;
  background: var(--wysiwyg-status-bg);
  color: var(--fg);
  display: none; align-items: center; gap: 8px;
  padding: 4px 10px; font-size: 12px; z-index: 3;
  border: 1px solid var(--border);
  border-radius: 999px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  pointer-events: none; /* 不遮挡点击编辑 */
}
.container.wysiwyg .wysiwyg-status.show { display: inline-flex; }

/* 所见模式：为状态条让出上内边距 */
.container.wysiwyg .preview { background: var(--wysiwyg-bg); padding-top: 14px; }
.container.wysiwyg .editor { padding-top: 14px; }

/* === 行距优化（代码块）=== */
/* 预览模式：使用舒适的行距以提高可读性 */
.preview pre code { line-height: 1.8 !important; }
/* 所见模式：保持一致的行距 */
.container.wysiwyg .preview pre,
.container.wysiwyg .preview pre code { line-height: 1.6 !important; }

/* WYSIWYG 下的 KaTeX 行内公式在某些字体/缩放下会出现下探溢出，
   导致与下一行内容视觉重叠。仅在所见模式中为 .katex 增加少量底部留白，
   同时提高其行高参与行盒计算，避免与后续文本叠压。*/
.container.wysiwyg .preview .katex {
  display: inline-block;
  vertical-align: baseline;
  line-height: 1.2;          /* 提高自身行高，参与行盒最大值计算 */
  padding-bottom: 0.2em;     /* 增加下边距，给根号等下探元素留出余量 */
}
.container.wysiwyg .preview .katex-display { /* 块级公式也稍作留白，防止与段落挤在一起 */
  margin: 0.6em 0;
}

/* 仅隐藏横向滚动条外观（不影响滚动功能），竖向滚动条保持可见 */
html::-webkit-scrollbar:horizontal,
body::-webkit-scrollbar:horizontal,
#app::-webkit-scrollbar:horizontal,
.container::-webkit-scrollbar:horizontal,
.preview::-webkit-scrollbar:horizontal,
#md-wysiwyg-root::-webkit-scrollbar:horizontal,
.library::-webkit-scrollbar:horizontal { height: 0 !important; }

/* 为主要滚动容器显式展示竖向滚动条（跨浏览器） */
/* Firefox */
.preview, #md-wysiwyg-root, .library { scrollbar-width: thin; scrollbar-color: rgba(127,127,127,0.45) transparent; }
/* WebKit/Chromium */
.preview::-webkit-scrollbar:vertical,
#md-wysiwyg-root::-webkit-scrollbar:vertical,
.library::-webkit-scrollbar:vertical { width: 10px; }
.preview::-webkit-scrollbar-thumb,
#md-wysiwyg-root::-webkit-scrollbar-thumb,
.library::-webkit-scrollbar-thumb {
  background: rgba(127,127,127,0.45);
  border-radius: 999px;
  border: 2px solid transparent; /* 让拇指更细更圆润 */
  background-clip: content-box;
}
.preview::-webkit-scrollbar-track,
#md-wysiwyg-root::-webkit-scrollbar-track,
.library::-webkit-scrollbar-track { background: transparent; }
/* WebDAV 同步：标签左对齐、警告缩进与横排开关 */
.upl-grid > label { justify-self: start; text-align: left; }
.upl-hint.warn { color: #ff9800; }
.upl-hint.pad-1ch { padding-left: 1ch; }
.upl-grid .sync-toggles { grid-column: 1 / -1; display: flex; align-items: center; gap: 16px 24px; flex-wrap: wrap; }
.sync-toggles .item { display: inline-flex; align-items: center; gap: 8px; white-space: nowrap; }
.sync-toggles .lbl { font-size: 12px; color: var(--muted); }

/* === 打印样式 - 确保打印整个文档而不仅是可视范围 === */
@media print {
  /* 隐藏所有UI元素 */
  .titlebar,
  .statusbar,
  .library,
  .recent-panel,
  .wysiwyg-status,
  .wysiwyg-line,
  .wysiwyg-caret,
  .code-copy,
  .code-lang {
    display: none !important;
  }

  /* 移除容器的高度限制，确保打印全部内容 */
  html, body, #app {
    height: auto !important;
    overflow: visible !important;
  }

  .container {
    height: auto !important;
    overflow: visible !important;
    position: static !important;
  }

  /* 预览区域：移除所有限制，显示完整内容 */
  .preview {
    position: static !important;
    overflow: visible !important;
    height: auto !important;
    max-height: none !important;
    padding: 0 !important;
    margin: 0 !important;
    inset: auto !important;
  }

  /* 隐藏编辑器，只打印预览 */
  .editor {
    display: none !important;
  }

  /* 确保预览内容可见 */
  .preview.hidden {
    display: block !important;
  }

  /* 预览正文：移除宽度限制，使用全宽 */
  .preview-body {
    max-width: 100% !important;
    margin: 0 !important;
  }

  /* 确保库侧栏不影响布局 */
  .container.with-library .preview {
    padding-left: 0 !important;
  }

  /* 代码块：避免分页截断 */
  .preview pre {
    page-break-inside: avoid;
    break-inside: avoid;
  }

  /* 图片：避免分页截断 */
  .preview img {
    page-break-inside: avoid;
    break-inside: avoid;
    max-width: 100% !important;
  }

  /* 表格：避免分页截断 */
  .preview table {
    page-break-inside: avoid;
    break-inside: avoid;
  }

  /* 标题：避免孤立在页面底部 */
  .preview h1,
  .preview h2,
  .preview h3,
  .preview h4,
  .preview h5,
  .preview h6 {
    page-break-after: avoid;
    break-after: avoid;
  }

  /* 移除背景色，节省墨水 */
  body, .preview {
    background: white !important;
    color: black !important;
  }

  /* 代码块保持浅色背景以便区分 */
  .preview pre {
    background: #f5f5f5 !important;
    border: 1px solid #ddd !important;
  }

  /* 链接：显示URL */
  .preview a[href]:after {
    content: " (" attr(href) ")";
    font-size: 0.8em;
    color: #666;
  }
}
